{% extends "base.html" %}
{% block title %}Add New Item{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
  <div class="bg-white shadow overflow-hidden sm:rounded-lg">
    <form id="inventory-form" method="POST" enctype="multipart/form-data">
      <div class="px-4 py-5 sm:px-6 flex justify-between items-center border-b border-gray-200">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Item</h3>
      </div>

      <div class="px-4 py-5 sm:p-6">
        <div class="grid grid-cols-6 gap-6">
          <!-- Upload and OCR Section First -->
          <div class="col-span-6 sm:col-span-3">
            <label for="image" class="block text-sm font-medium text-gray-700">Upload New Image</label>
            <input type="hidden" id="raw_ocr_text" name="raw_ocr_text">
            <input type="file" name="image" id="image" accept="image/*"
                   class="mt-1 block w-full shadow-sm sm:text-sm">
            <button type="button" id="ocr-button"
                    class="mt-2 w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Scan for OCR & Barcode
            </button>
          </div>

          <!-- Serial Number -->
          <div class="col-span-6 sm:col-span-3">
            <label for="serial_number" class="block text-sm font-medium text-gray-700">Serial Number</label>
            <div class="mt-1 relative rounded-md shadow-sm">
              <input type="text" name="serial_number" id="serial_number" class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pr-10 sm:text-sm border-gray-300 rounded-md" placeholder="Enter or scan serial number">
              <button type="button" id="serial-search-button" class="absolute inset-y-0 right-0 px-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1111.446 3.032l4.743 4.744a1 1 0 01-1.414 1.414l-4.744-4.743A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Name Field (populated by OCR) -->
          <div class="col-span-6 sm:col-span-4">
            <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
            <textarea name="name" id="name" rows="3"
                   class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
                   placeholder="Detected name will appear here"></textarea>
          </div>

          <!-- Quantity Field -->
          <div class="col-span-6 sm:col-span-3">
            <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
            <input type="number" name="quantity" id="quantity" class="w-full px-4 py-2 border rounded" placeholder="Enter quantity" value="1">
          </div>

          <!-- More Details Button -->
          <div class="col-span-6">
            <button type="button" id="more-details-button" class="w-full py-2 bg-gray-300 text-gray-700 rounded">More Details</button>
          </div>

          <!-- Additional Fields (Initially Hidden) -->
          <div id="additional-fields" class="col-span-6 grid grid-cols-6 gap-6 hidden mt-4">
            <!-- Box -->
            <div class="col-span-6 sm:col-span-2">
              <label for="box" class="block text-sm font-medium text-gray-700">Box</label>
              <input type="text" name="box" id="box" class="w-full px-4 py-2 border rounded" placeholder="Enter box number">
            </div>

            <!-- Boat Section -->
            <div class="col-span-6 sm:col-span-3">
              <label for="boat_section_id" class="block text-sm font-medium text-gray-700">Boat Section</label>
              <select id="boat_section_id" name="boat_section_id"
                      class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <option value="">Select Section</option>
                  {% for section in sections %}
                      <option value="{{ section.id }}">{{ section.name }}</option>
                  {% endfor %}
                  <option value="new_section">--> Add New Section <--</option>
              </select>
              <div id="new-section-input" class="mt-2 hidden">
                <label for="new_section_name" class="text-sm font-medium text-gray-700">New Section Name</label>
                <input type="text" id="new_section_name" name="new_section_name" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
              </div>
            </div>

            <!-- Shelf -->
            <div class="col-span-6 sm:col-span-2">
              <label for="shelf" class="block text-sm font-medium text-gray-700">Shelf</label>
              <select id="shelf" name="shelf"
                      class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                  <option value="">Select Shelf</option>
                  <option value="new_shelf">--> Add New Shelf <--</option>
              </select>
              <div id="new-shelf-input" class="mt-2 hidden">
                <label for="new_shelf_name" class="text-sm font-medium text-gray-700">New Shelf Name</label>
                <input type="text" id="new_shelf_name" name="new_shelf_name" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
              </div>
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="mt-4">
          <button type="submit" class="w-full py-2 bg-green-500 text-white rounded">Add Item</button>
        </div>
      </div>
    </form>
  </div>


{% block extra_js %}
<script src="{{ url_for('static', filename='js/ocr-handler.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const ocrHandler = new OCRHandler();
    const form = document.querySelector('form');
    const serialNumberInput = document.getElementById('serial_number');
    const boatSectionSelect = document.getElementById('boat_section_id');
    const nameInput = document.getElementById('name');
    const quantityInput = document.getElementById('quantity');
    const boxInput = document.getElementById('box');
    const shelfSelect = document.getElementById('shelf');
    const imageInput = document.getElementById('image'); // The file input element
    const formElements = document.querySelectorAll('input, select, button:not(#ocr-button, #image)');
    const moreDetailsButton = document.getElementById('more-details-button');
    const additionalFields = document.getElementById('additional-fields');

    // "More Details" button event listener
    moreDetailsButton.addEventListener('click', function () {
        additionalFields.classList.toggle('hidden');
    });

    // Handle form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        await ocrHandler.saveCorrection(this);
        this.submit();
    });

    // OCR and Barcode scan button event
    const ocrButton = document.getElementById('ocr-button');
    ocrButton.addEventListener('click', async function() {
        if (imageInput.files.length > 0) {
            const formData = new FormData();
            formData.append('image', imageInput.files[0]);
            try {
                const response = await fetch('/mobile/ocr', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                await ocrHandler.handleOCRResult(result);

                // Populate fields if OCR result has values
                if (result.serial_number) serialNumberInput.value = result.serial_number;
                if (result.name) nameInput.value = result.name;

                // Enable all fields after OCR is completed
                disableFields(false);
            } catch (error) {
                console.error('OCR error:', error);
                alert('Failed to process OCR.');
            }
        } else {
            alert('Please upload an image first.');
        }
    });

    // Disable all fields initially except serial number and image upload
    disableFields(true);

    // Serial Number Search Trigger
    const serialSearchButton = document.getElementById('serial-search-button');
    if (serialSearchButton) {
        serialSearchButton.addEventListener('click', async function () {
            const serialNumber = serialNumberInput.value.trim();
            if (serialNumber) {
                try {
                    const response = await fetch(`/inventory/data?serial=${serialNumber}`);
                    const data = await response.json();

                    if (data.length === 1) {
                        // Pre-fill the fields with the found item
                        const item = data[0];
                        nameInput.value = item.name || '';
                        quantityInput.value = item.quantity || '';
                        boxInput.value = item.location.box || '';

                        // Set boat section
                        setSelectOptionByText(boatSectionSelect, item.location.section);

                        // Enable all fields
                        disableFields(false);
                    } else if (data.length > 1) {
                        // Display search results if multiple items are found
                        showSearchResults(data);
                        disableFields(true);
                    } else {
                        // No items found, clear fields and enable all fields for new entry
                        clearFields();
                        disableFields(false);
                    }
                } catch (error) {
                    console.error('Error fetching inventory data:', error);
                    alert('Failed to retrieve item data.');
                }
            } else {
                alert('Please enter a serial number.');
            }
        });
    }

    // Boat Section Change Trigger
    boatSectionSelect.addEventListener('change', async function () {
        const selectedBoatSection = boatSectionSelect.options[boatSectionSelect.selectedIndex].text;
        if (selectedBoatSection === '--> Add New Section <--') {
            document.getElementById('new-section-input').classList.remove('hidden');
        } else {
            document.getElementById('new-section-input').classList.add('hidden');
            await populateShelves(selectedBoatSection);
        }
    });

    // Shelf Change Trigger
    shelfSelect.addEventListener('change', function () {
        const selectedShelf = this.value;
        if (selectedShelf === 'new_shelf') {
            document.getElementById('new-shelf-input').classList.remove('hidden');
        } else {
            document.getElementById('new-shelf-input').classList.add('hidden');
        }
    });

    // Function to populate shelves
    async function populateShelves(boatSectionName) {
        try {
            const response = await fetch(`/inventory/shelves?boat_section=${encodeURIComponent(boatSectionName)}`);
            const shelves = await response.json();

            // Clear current shelves but keep the default and "Add New" options
            shelfSelect.innerHTML = '<option value="">Select Shelf</option>';

            // Add fetched shelves
            shelves.forEach(shelf => {
                const option = document.createElement('option');
                option.value = shelf;
                option.textContent = shelf;
                shelfSelect.appendChild(option);
            });

            // Add the "Add New Shelf" option at the end
            const newShelfOption = document.createElement('option');
            newShelfOption.value = 'new_shelf';
            newShelfOption.textContent = '--> Add New Shelf <--';
            shelfSelect.appendChild(newShelfOption);
        } catch (error) {
            console.error('Error fetching shelves:', error);
            alert('Failed to retrieve shelves.');
        }
    }

    // Helper function to disable/enable all input fields except serial number, image upload, and OCR button
    function disableFields(disable) {
        formElements.forEach(el => {
            if (el !== serialNumberInput && el !== imageInput) {
                el.disabled = disable;
            }
        });
    }

    // Helper function to set a select element's option by text
    function setSelectOptionByText(selectElement, text) {
        for (let i = 0; i < selectElement.options.length; i++) {
            if (selectElement.options[i].text === text) {
                selectElement.selectedIndex = i;
                return;
            }
        }
    }
});
</script>
{% endblock %}

{% endblock %}
